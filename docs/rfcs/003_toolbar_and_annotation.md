# RFC 003: 标注系统与工具栏（架构与规范）

Status: Implemented

## 范围
以架构与实现指导的视角，定义截图标注系统的整体设计原则、共性需求、各标注工具的细化需求与技术特点、交互模型、性能与扩展策略。用于指导编码与演进，而非代码索引或变更记录。

## 设计原则
- 一致性：查看态与编辑态渲染、几何、层级保持一致；属性修改所见即所得。
- 可预期：工具切换、命中与拖拽、快捷键与删除等行为规则明确且稳定。
- 可扩展：新工具接入不破坏既有模型；属性面板与命中策略可复用与插拔。
- 可维护：数据模型清晰、状态边界明确、渲染与交互分层，便于测试与回归。

## 共性需求（所有标注工具）
- 创建与编辑模型
  - 鼠标按下→拖动→释放创建；`Shift` 约束比例与角度；最小尺寸与拖动阈值（默认 `3px`）。
  - 选择模式自动进入：点击已有标注即选中；支持移动与缩放（8 控制点）。
  - 删除：`Delete/Backspace` 删除选中；序号的文字删除仅移除 Label，保留 Badge。
- 命中测试原则
  - 填充形状：内部点命中（矩形/椭圆）。
  - 非填充形状：使用加粗描边命中，提升容错（线段/箭头/轮廓）。
  - 文字编辑态：事件路由优先给编辑组件；查看态：命中渲染对象。
- 属性面板通用模型
  - 左（大小/透明度）+ 中（颜色矩阵）+ 右（底色/粗体/字体），右侧两行统一高度与基线。
  - 自适应：右侧宽度按内容动态；左侧数值标签按最大字符串测量；整体仅水平重排避免遮挡。
- 光标与层级
  - 绘制工具为十字；非编辑态控制点与可拖拽区域为手型；编辑态文本为 I 光标。
  - 绘制顺序：编辑态先绘制指向线，再绘制主体；选择高亮与编辑边框在标注之后绘制。
- 工具切换与创建优先级
  - 切到绘制工具后，首次点击优先进入“新增”流程（超阈值开始创建），随后恢复正常命中。
  - 文字与序号在刚创建且未切换工具时，抑制一次空白点击的再次创建；切换工具立即允许创建。

## 工具细化需求与技术特点

### 矩形（Rectangle）
- 交互
  - 支持 8 个控制点缩放；`Shift` 保持正方；填充态内部点击命中拖拽；选择态整体移动与缩放分离。
- 配置
  - 颜色、线宽、填充开关、圆角开关、透明度；圆角半径规范化（视觉统一）。
- 尺寸模型
  - 大小含义为描边线宽（单位：px）；属性面板显示与调节范围建议 `1–20px`。
- 技术
  - 路径抗锯齿与像素对齐；圆角路径构建稳定；命中在非填充时采用加粗描边容差。

### 椭圆（Ellipse）
- 交互
  - 8 向缩放与中心移动；`Shift` 保持正圆；填充态内部点击命中拖拽；选择态显示控制点。
- 配置
  - 颜色、线宽、填充开关、透明度；最小半径与比例约束。
- 尺寸模型
  - 大小为描边线宽（px）；建议范围 `1–20px`。
- 技术
  - 椭圆路径参数化；命中容差与描边一致；避免极小半径导致的像素抖动。

### 直线（Line）
- 交互
  - 端点独立拖拽与整体移动分离；`Shift` 吸附水平/垂直/45°；选择态显示端点手柄与命中区域。
- 配置
  - 颜色、线宽、透明度；端点吸附开启条件（按 `Shift`）。
- 尺寸模型
  - 大小为线宽（px）；建议范围 `1–20px`。
- 技术
  - 角度吸附步进与距离计算；端点手柄命中容差与视觉尺寸匹配。

### 箭头（Arrow）
- 交互
  - 端点编辑与吸附行为与直线一致；整体移动与端点编辑分离；箭头头部随线宽与方向自适应。
- 配置
  - 颜色、线宽、透明度；（预留）头部样式参数：角度与长度比例。
- 尺寸模型
  - 大小为线宽（px），头部几何从线宽与长度推导；建议范围 `1–20px`。
- 技术
  - 保持最小长度避免头部畸变；头部绘制与线段无缝衔接。

### 画笔（Pen）
- 交互
  - 拖动过程中持续采样点集；选择后整体移动；MVP 不提供分点编辑；撤销按段。
- 配置
  - 颜色、线宽、透明度；（实现侧）采样率与平滑策略参数。
- 尺寸模型
  - 大小为笔画线宽（px）；建议范围 `1–20px`。
- 技术
  - 路径简化与平滑（如 RDP）；点数上限与分片绘制；抗锯齿优化。

### 文字（Text）
- 交互
  - 点击创建并立即输入；双击进入编辑；编辑态显示实线边框；事件优先路由到编辑组件；中文 IME 合成期即时测量与扩宽。
- 配置
  - 字体族、字号、粗体、颜色、背景填充、透明度、描边样式与颜色；属性隔离，编辑结束后合并。
- 尺寸模型
  - 大小含义为字号（单位：pt）；建议范围 `10–100pt`；编辑态与查看态行高一致。
- 技术
  - 禁用容器宽度导致换行；实时重算与重绘，保持边框与几何同步；所见即所得。

### 序号（Counter）
- 交互
  - 点击创建徽章并自动递增；双击编辑 Label；首次拖拽按命中部件移动（文字/徽章独立）；删除 Label 保留徽章；编辑态保留连接线且不遮挡徽章。
- 配置
  - 序号颜色；文字配置与 Text 工具一致（字体族、字号、粗体、底色、透明度）；非编辑态“文字大小”仅影响 Label；徽章缩放通过拖拽徽章。
- 尺寸模型
  - 文字大小为字号（pt）；徽章大小独立基准（badge 基准，推导半径与内部数字字号），与文字大小解耦；连接线宽固定或与徽章/文字风格协调。
- 技术
  - 两部分独立命中与移动；连接线终点按 Label 矩形边缘计算；徽章在连接线上方的层级；递增策略（MVP 保持不变）。

### 马赛克（Mosaic，预留）
- 交互
  - 矩形或自由区域选择；强度调整；与标注层复合显示；支持连续涂抹与撤销。
- 配置
  - 模式（像素化/模糊）、强度、半径、区域类型（矩形/自由）、透明度。
- 尺寸模型
  - 半径与强度为关键参数；展示层与标注层的合成顺序统一。
- 技术
  - GPU 优先；分块与缓存；性能与层级控制；与截图底图的混合模式规范。

## 交互规范与快捷键
- 拖动阈值与最小尺寸规范；比例与角度吸附策略。
- 删除、撤销/重做、确认与关闭等基础操作统一行为与快捷键映射。
- 选中态的控制点与手柄语义统一；编辑态边框仅视觉提示不提供拖拽（可选扩展）。

## 性能与实现建议
- 绘制循环：批量绘制，必要时采用离屏渲染；减少状态切换与上下文保存。
- 命中优化：按需空间索引（网格/四叉树）；形状优先粗判（包围盒）后细判（路径）。
- 文本编辑：减少布局抖动；在 IME 合成期避免频繁换行与 measure 震荡。

## 扩展与演进
- 工具接入：遵循 `Annotation` 协议；属性面板支持插件式扩展；工具栏按钮通过统一注册。
- 行为一致性：新工具遵循共性需求与交互规范；专属属性与命中策略在细化需求中定义。
- 文档治理：RFC003 作为全局规范，子 RFC（如交互细节或性能专题）专注单点并与本规范保持一致。

## 结论
该文档为标注系统的架构与实现指导，明确共性与各工具的细化要求，统一交互与技术策略，保证一致性、可预期与可扩展，便于持续演进。
