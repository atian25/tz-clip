## 概述
- 思路：逐一定位交互缺陷（命中测试、双击编辑、编辑态尺寸与遮挡），在不破坏既有架构的前提下，修正判定逻辑与编辑态的 UI 更新，保持行为与 RFC003 的目标一致。
- 范围：`Rectangle/Ellipse` 的命中测试；`Counter/Text` 的双击进入编辑态防止误创建；编辑态文字实时响应字号滑块并保持面板不被遮挡；选择边框在编辑态的可视一致性。

## 问题与原因分析
1) 实心矩形/圆形中间不可拖拽，点击会创建新标注
- 现象：当 `isFilled=true` 时，在形状中心单击无法命中已绘制形状，落入“空白点击”分支，从而创建新标注。
- 根因：命中仅判定描边路径，未考虑填充区域。
  - 证据：`Sources/TZClip/Annotations/RectangleAnnotation.swift:32-36`、`EllipseAnnotation.swift:24-28` 的 `contains(point:)` 使用**描边后的路径**进行判定，即使 `isFilled=true` 也未使用填充路径或矩形/椭圆几何。

2) 序号标注文字双击进入编辑时，容易触发新标注创建
- 现象：双击欲进入编辑态，但过程中（第二次点击松开）仍走到了“空白点击创建”路径，导致误新增一枚序号。
- 根因：双击进入编辑态后，未抑制随后的 `mouseUp` 中的空白创建；且 `mouseDown` 顶部对 `activeTextView` 的统一收束会过早结束编辑。
  - 证据：`Sources/TZClip/AnnotationOverlayView.swift:531-563` 双击命中后直接 `startTextEditing`，未设置创建保护；`818-858` 的 `.counter` 分支在 `skipNextBlankClickCreation=false` 时即创建；`519-527` 对存在 `activeTextView` 的点击统一结束编辑。

3) 文本/序号编辑态拖动字号滑块时被遮盖，边框退出编辑后才跟随变大
- 现象：编辑时调整字号，面板易被编辑框遮挡，且尺寸/边框更新不实时，退出编辑态后才看到边框变化。
- 根因：
  - 编辑态字号变更仅更新 `NSTextView.font`，未同步依据新字体度量重算编辑框尺寸。
  - 编辑态被设计为隐藏选中高亮（`selectedAnnotationID=nil`），视觉上缺少“边框实时跟随”的反馈。
  - 面板与编辑框的层级与避让虽基本正确，但在选区靠近面板时易产生遮挡感知。
  - 证据：`Sources/TZClip/AnnotationOverlayView.swift:286-323` 的 `updateActiveTextView()` 未做尺寸重算；`Sources/TZClip/AnnotationOverlayView.swift:536-558`/`547-558` 进入编辑前将 `selectedAnnotationID=nil`；面板布局见 `Sources/TZClip/Services/ToolbarLayoutService.swift:3-26`。

## 方案设计（RFC）
### A. 填充形状的命中测试修正
- 规则：
  - 当 `isFilled=true` 时，矩形与椭圆命中应使用填充区域（形状内部）判定；当 `isFilled=false`，继续使用描边宽度的容错判定。
- 变更：
  - `RectangleAnnotation.contains(point:)`：`isFilled ? rect.contains(point) : strokedPath.contains(point)`。
  - `EllipseAnnotation.contains(point:)`：`isFilled ? CGPath(ellipseIn:rect).contains(point) : strokedPath.contains(point)`。
- 影响：
  - 中心拖拽将正确进入“命中已选中 -> 移动”的路径，避免误创建。

### B. 双击编辑态的创建保护与编辑收束优化
- 规则：双击进入文本编辑后，直至结束编辑前，必须抑制“空白点击创建”。
- 变更：
  - 在双击命中分支中，调用 `startTextEditing(...)` 前后同时设置 `skipNextBlankClickCreation=true`，确保随后一次 `mouseUp` 不会创建新标注（与现有保护语义一致）。
  - 优化 `mouseDown` 顶部对 `activeTextView` 的处理：仅当点击**编辑框之外**时结束编辑；点击编辑框内部应继续编辑不打断。
- 影响：
  - 双击进入编辑不再误触发新序号/文字。
  - 编辑体验更稳定，避免“刚双击就被收束退出”的情况。

### C. 编辑态字号变更的实时尺寸与视觉反馈
- 规则：编辑态拖动字号滑块，编辑框尺寸与渲染需实时刷新；同时保持面板不被遮挡及边框反馈的一致性。
- 变更：
  - 在 `updateActiveTextView()` 中，除设置 `font/textColor/background` 外，使用当前字符串与新字体度量重算 `NSTextView.frame.size`（与 `textDidChange` 的测量一致）。
  - 在编辑 Counter 的 Label 时，维持 `selectedAnnotationID` 与 `selectedCounterPart=.label`，或在 `draw(_:)` 中对 `activeTextView.frame` 绘制轻量虚线高亮，提供“边框跟随”的实时反馈。
  - 再确认面板层级：保证 `AnnotationPropertiesView` 始终位于 `AnnotationOverlayView` 之上（当前 add 顺序已满足），必要时通过 `addSubview(_:positioned:relativeTo:)` 强化。
- 影响：
  - 滑块变更可见即所得；面板不被编辑框视觉遮挡；边框反馈在编辑态保持一致。

## 代码改动点（指引）
- `Sources/TZClip/Annotations/RectangleAnnotation.swift:32-36`
  - 修改 `contains(point:)`：`isFilled` 分支返回 `rect.contains(point)`。
- `Sources/TZClip/Annotations/EllipseAnnotation.swift:24-28`
  - 修改 `contains(point:)`：`isFilled` 分支返回 `ellipsePath.contains(point)`。
- `Sources/TZClip/AnnotationOverlayView.swift`
  - `mouseDown`：
    - 双击命中分支 `531-563`：在进入 `startTextEditing(...)` 前后设置 `skipNextBlankClickCreation=true`；并在顶部 `519-527` 处仅在点击编辑框外部时才 `endTextEditing()`。
  - `updateActiveTextView() 286-323`：依据当前 `textView.string` + 新 `font`，重算 `frame.size`（复用 `textDidChange` 的计算逻辑 `1139-1155`）。
  - （可选）`draw(_:)` 或选择高亮：编辑态情况下对 `activeTextView.frame` 画轻量高亮框，或保留 `selectedAnnotationID` 以便 `drawSelection` 使用现有路径。

## 测试与验证
- 单元测试：
  - `CounterAnnotationTests`：双击后不创建新标注；`skipNextBlankClickCreation` 语义正确。
  - `HandleGeometryServiceTests`：不涉及，但回归确保不受影响。
  - 新增 `Rectangle/Ellipse` 命中测试：`isFilled=true` 时中心点命中；`isFilled=false` 时仅描边附近命中。
- 手动验证：
  - 实心矩形/圆形中心拖拽命中移动。
  - 序号/文字双击进入编辑不会新增。
  - 编辑态拖动字号，编辑框尺寸与边框实时更新；面板保持可见。

## 风险与回退
- 风险：命中规则变更可能影响用户对细边形状的选择感知；编辑态边框绘制需避免与现有选择高亮冲突。
- 回退：保留原判定逻辑分支，快速切回；编辑态高亮可通过开关回滚。

## 计划（Plan）
1. 更新 `Rectangle/Ellipse.contains` 填充命中分支。
2. 在双击编辑路径设置创建保护，优化编辑收束条件。
3. 完善 `updateActiveTextView()`，实时重算编辑框尺寸。
4. （可选）编辑态维持选择高亮或绘制临时高亮框。
5. 编写/补充单元测试并回归验证。
6. 启动应用，交互回归并录屏确认。

请确认 RFC 与实施计划；确认后我按上述步骤执行并提供可预览验证。